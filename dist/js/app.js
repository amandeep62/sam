"use strict";define(["jquery","Mustache","mst","darktooltip","animateCss","jqueryFileDownload","cookie","moment","humps","rtlApis","appActions","json!mock/userToken.json"],function(c,d,p,e,t,r,v,n,s,f,a,i){var o=c(".container"),l=c(window),u={userInfo:{name:null}};u.timeNow=n.utc(new Date),u.timeDiff=0,u.runningTimer=0,u.runningTimerCounter=0,u.startTime=null,u.endTime=null,u.interval=0,u.targetDevice=null,u.dId=null,u.rId=null,u.params={async:!0,processData:!0,contentType:"application/json;charset=utf-8",crossDomain:!0,enctype:!1,token:null,rId:null},u.isDeveloper=!1,u.insideIframe=!1,u.videoHistory=[],u.progressSteps=null,u.header=null,u.viewTrigger=!0,u.refreshTrigger=!0,-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")?c("body").append('<link rel="stylesheet" type="text/css" href="css/safari.css">'):-1!=navigator.userAgent.indexOf("Chrome")&&c("body").append('<link rel="stylesheet" type="text/css" href="css/chrome.css">'),p.callMst("header",function(e){u.header=e});var m=function(){c("ins").length&&c("ins").remove(),c(".insideApp").removeClass(".insideApp")},h=function(s,i,e){u.timeDiff=0,u.runningTimer=0,u.runningTimerCounter=0,u.startTime=null,u.endTime=null,u.interval=0,u.rtlState={platforms:{android:!1,tizen:!1},series:[],osVersions:[],carriers:[],models:{android:{sSeries:!1,noteSeries:!1,tabletSeries:!1},tizen:{}},reserve:{models:[],subModels:[]}},p.callMst("progressSteps",function(e){u.progressSteps=e}),m(),u.insideIframe=s,u.userInfo=Object.assign({},u.userInfo,i),f.rtlApi("GET",u.params,null,"device-service/api/platforms",function(e){if(e.statusText&&"error"===e.statusText)console.log("Error : error back from Server");else{for(var t=0;t<e.length;t++)u.rtlState.platforms[e[t].toLowerCase()]=!0;p.callMst("selectPlatform",function(e){var t=d.render(e,{platforms:u.rtlState.platforms,username:i.name,iFrame:s},{header:u.header,progressSteps:u.progressSteps});for(var r in o.removeAttr("style").addClass(o.hasClass("flexed")?null:"flexed flex-column").html(t).hide().fadeIn("slow"),u.rtlState.platforms)c("#rtl-"+r+" > img").darkTooltip({trigger:"click",animation:"flipIn",gravity:"south"})})}})},g=function(){clearInterval(u.runningTimer),a.disconnect("reload",function(e){e&&h(u.insideIframe,u.userInfo)})},b=function(e){new Date(u.timeNow).getTime()>n.utc(new Date(v.get("expiresIn")).getTime())&&v.remove("existingToken"),v.get("existingToken")?(i[0].token=v.get("existingToken"),w(u.insideIframe,i[0],i)):p.callMst("login",function(e){var t=d.render(e,{});o.addClass("flexed flex-column").html(t).hide().fadeIn("slow"),c(".login-field").keypress(function(e){13===e.which&&c(".login-submit").trigger("click")}),c(".login-submit").click(function(){var e;c(".login-submit-semicircle-bg.bg2").addClass("loading"),e={client_id:"rest-client",client_secret:"be0d61f2-ad3f-4fea-9aef-42a47f5a1fe8",username:c('.login-box > [type="text"]').val(),password:c('.login-box > [type="password"]').val(),grant_type:"password"},u.params.contentType="application/x-www-form-urlencoded",f.rtlApi("POST",u.params,e,"auth/realms/haystack/protocol/openid-connect/token",function(e){c(".login-submit-semicircle-bg.bg2").removeClass("loading"),"Unauthorized"!==e.statusText&&"invalid_grant"!==e.statusText?"error"===e.statusText?alert("Please Enable CORS for refresh expired token \nAnd after getting session Disable CORS back."):(v.set("expiresIn",u.timeNow.add(e.expires_in,"seconds")),v.set("existingToken",e.access_token),i[0].token=e.access_token,w(u.insideIframe,i[0],i)):alert("Check your credentials.")})})})},k=function(e,t){u.runningTimerCounter=u.runningTimerCounter-1e3;var r=e?t-u.runningTimerCounter:t;u.timeDiff=u.endTime.diff(r);var s=n.duration(u.timeDiff);return s.valueOf()<0&&g(),(s.hours()<10?"0"+s.hours():s.hours())+":"+(s.minutes()<10?"0"+s.minutes():s.minutes())+":"+(s.seconds()<10?"0"+s.seconds():s.seconds())},T=function(r,s,i){u.insideIframe=r,i&&(u.dId=i.deviceId,u.rId=i.reservationId,u.endTime=n.utc(i.endTime)),u.userInfo=Object.assign({},u.userInfo,s),p.callMst("appView-07031140",function(e){var t=d.render(e,{username:s.name,role:u.isDeveloper,S7:"S7"===i.model||"S7 Active"===i.model,iFrame:r},{header:u.header});o.removeClass("flexed flex-column").html(t).hide().fadeIn("slow"),c(".historyBtn").addClass("insideApp"),c(".device-panel").append('<div class="loader"></div>'),a.connect(u.dId,u.rId,u.userInfo.token),c("#disconnect").darkTooltip({trigger:"click",theme:"light",animation:"flipIn",gravity:"north",confirm:!0,modal:!0,onYes:function(){g()},yes:"Yes",no:"No"}),c("#Wipe").darkTooltip({trigger:"hover",animation:"flipIn",gravity:"north"}),p.callMst("breadcrumb",function(e){var t=d.render(e,{model:i.product,subModel:i.model,osVersion:i.osVersion,deviceId:u.dId,role:u.isDeveloper,resTimer:k(0,n.utc(i.currentServerTime))});c(".steps.steps-3").append(t),u.runningTimer=setInterval(function(){c(".reservation-left-timer").text("("+k(1,n.utc(i.currentServerTime))+")")},1e3)}),p.callMst("apkPanel",function(e){var t=d.render(e,{});c(".panels-container").append(t),c("#def-apk").darkTooltip({trigger:"click",theme:"light",animation:"flipIn",gravity:"north",modal:!0,onClose:function(){"Upload"===c("#darktooltip-def-apk .upload-btn-text").text()&&(c(".loadProgress").width("0"),c(".upload-btn").removeClass("progressStatus"),c(".upload-btn-text").text("Upload"),c(".apk-view .apkStatus").empty())}})}),p.callMst("toolbar",function(e){var t=d.render(e,{S7:"S7"===i.model||"S7 Active"===i.model});c(".panels-container").prepend(t),c(".power, .home , .go_back, .recent_apps, .vol_up, .vol_down, .bixby, .rotate").darkTooltip({animation:"flipIn",gravity:"west"})})})},w=function(t,r,s){r.token&&(u.params.token=r.token,u.params.rId=r.rId),u.isDeveloper=!!r&&r.devRole,u.params.contentType="application/json;charset=utf-8",f.rtlApi("GET",u.params,null,"reservation-service/api/reservations/status=in_progress",function(e){"localhost"===window.location.hostname&&401===e.status&&e.responseText&&"Unauthorized"===JSON.parse(e.responseText).error?b():(u.endTime=0<e.length?n.utc(e[0].endTime):null,0!==e.length&&"in_progress"===e[0].reservationStatus&&0<u.endTime.diff(u.timeNow)?T(t,s?s[0]:r,e[0]):h(t,s?s[0]:r,e[0]))})},y=function(e,r,t){if(e.sort(function(e,t){return new Date(t.createdDate)-new Date(e.createdDate)}),u.videoHistory=[],e.statusText&&"error"===e.statusText)console.log("Error : error back from Server");else{for(var s=0;s<e.length;s++){var i=n.utc(e[s].startTime).toDate(),a=u.timeNow.diff(n.utc(e[s].startTime));(0<n.duration(a).days()&&e[s].isVideoExists||0===n.duration(a).days())&&u.videoHistory.push({idx:s,createdDate:n.utc(e[s].startTime).format("MMMM Do YYYY"),age:n(i).local().format("h:mm:ss a"),expires:n(n(e[s].startTime).add(7,"d").format("YYYY/MM/DD HH:mm:mm")).local().fromNow(),videoUrl:e[s].isVideoExists?e[s].videoUrl:null,rId:e[s].reservationId,isVideoExists:e[s].isVideoExists,is32bit:-1!==navigator.userAgent.indexOf("WOW64")})}t?p.callMst("historyPanel",function(e){var t=d.render(e);c(r).append(t),p.callMst("historyItems",function(e){var t=d.render(e,{videoHistoryRes:u.videoHistory});c(".listItems").append(t)})}):p.callMst("historyItems",function(e){c(".videoList, .loader").remove();var t=d.render(e,{videoHistoryRes:u.videoHistory});c(".listItems").append(t),u.refreshTrigger=!0}),u.viewTrigger=!0}},S=function(t){var e=c(".history.panel");!e.length&&u.viewTrigger?(u.viewTrigger=!1,f.rtlApi("GET",u.params,null,"reservation-service/api/reservations/status=complete",function(e){y(e,t,1),c(t).on("click",".videoList",function(e){var t=c(this);if(e.target!==c(this).find("video")[0])if(t.hasClass("selected"))c(e.target).hasClass("clear")?f.rtlApi("DELETE",u.params,null,"reservation-service/api/reservations/"+c(this).attr("data-rId")+"/video",function(e){t.animateCss("bounceOut",function(){t.remove()})}):t.removeClass("selected").find(".content").animateCss("flipOutX",function(){t.find(".content").hide()});else{var r=c(".selected");0<r.length&&(r.find("video")[0].pause(),r.removeClass("selected")),t.parent().find(".content").hide(),t.addClass("selected").find(".content").show().css("display","flex").animateCss("flipInX")}else e.preventDefault()}),c(t).on("click",".history .clear-all",function(){var e=c.map(c(".videoList"),function(e){return c(e).attr("data-rId")});f.rtlApi("DELETE",u.params,null,"reservation-service/api/reservations/"+e+"/video",function(e){c(".videoList").animateCss("bounceOut",function(){c(".videoList").remove()})})}),c(t).on("click",".history .refresh",function(){0===c(".history").find(".loader").length&&c(".panel-header").append('<div class="loader"></div>'),u.refreshTrigger&&(u.refreshTrigger=!1,f.rtlApi("GET",u.params,null,"reservation-service/api/reservations/status=complete",function(e){setTimeout(function(){y(e,t,0)},150)}))})})):e.remove()};o.on("click","#rtl-android, #rtl-tizen, .icon-loop2",u,function(e){if(c(this).hasClass("icon-loop2"))e.data.rtlState.reserve={models:[],subModels:[]},h(e.data.insideIframe,e.data.userInfo);else{var t=c(this).attr("id").split("rtl-")[1];c(".progressbar-bg li:first-child").addClass("active"),c(".progressbar li:first-child").addClass("icon-checkmark active"),c(this).hasClass("greyed")||(a=t,m(),f.rtlApi("GET",u.params,null,"device-service/api/platforms/"+a+"/series",function(e){if(e.statusText&&"error"===e.statusText)console.log("Error : error back from Server");else{var i="android"===a,t=function(e){var t=i?u.rtlState.models.android:u.rtlState.models.tizen,r=d.render(e,t);for(var s in c(".platforms").html(r),t)c("#rtl-"+s+" > img").darkTooltip({trigger:"click",animation:"flipIn",gravity:"south"})};if(i)for(var r=0;r<e.length;r++){var s=e[r].toLowerCase();s.startsWith("s")?u.rtlState.models.android.sSeries=!0:s.startsWith("note")?u.rtlState.models.android.noteSeries=!0:u.rtlState.models.android.tabletSeries=!0}i?p.callMst("selectGalaxy",function(e){t(e)}):p.callMst("selectTizen",function(e){t(e)})}}))}var a}),o.on("click","#rtl-noteSeries, #rtl-sSeries, #rtl-tabletSeries, #rtl-tizen-phone, #rtl-tv, #rtl-gear, #rtl-family",function(){var r;c(this).hasClass("greyed")||(c(".progressbar-bg li:eq(1)").addClass("active"),c(".progressbar li:eq(1)").addClass("icon-checkmark  active"),u.targetDevice=c(this).is("#rtl-noteSeries")||c(this).is("#rtl-sSeries")||c(this).is("#rtl-tabletSeries")?"android":"tizen",r=c(this).attr("data-model"),m(),p.callMst("selectDevice",function(e){var t=d.render(e,{username:u.userInfo.name,iFrame:u.insideIframe});c(".platforms").remove(),c(".mainPanel").append(t),c(".progressbar li:first-child").addClass("icon-loop2"),u.rtlState.series.push(r),O(u.rtlState),A(u.rtlState,0)}),u.rtlState.reserve.models.push(u.targetDevice),u.rtlState.reserve.subModels.push(c(this).attr("data-model")))}),o.on("click",".historyBtn",function(){c(this).toggleClass("active"),c(this).hasClass("insideApp")?S(".panels-container"):S(".mainBody")});var I=function(e,t,r){if(c(e[t]).length){var s=c(e[t])[0].classList[0],i=c("."+s);i.hasClass("active")&&i.removeClass("active"),c(e[t]).remove(),"function"==typeof r&&r()}},C=function(e){c(".full-screen-error").remove();var t=c(".panel");l.width()<=950&&2<t.length?c(t[2]).animateCss("bounceOutRight",function(){I(c(".panel"),2,function(){"function"==typeof e&&e(2)})}):l.width()<=750&&1<t.length?c(t[1]).animateCss("bounceOutRight",function(){I(c(".panel"),1,function(){"function"==typeof e&&e(1)})}):l.width()<=600&&1===t.length?t.animateCss("bounceOutRight",function(){I(c(".panel"),0,function(){"function"==typeof e&&e(0)})}):l.width()<=305?0===c("full-screen-error").length&&c("body").append('<div class="full-screen-error"><div><div class="icon-warning alertIe animated infinite flash"></div> Unfortunately<br />App doesn\t support this viewport size.<br />Please Try on bigger screen.</div></div>'):"function"==typeof e&&e("reset")};c("body").on("submit","ins .form-group",function(e){a.uploadapk(e)}),o.on("click","button.avail-device",function(){u.reservebtn=c(this),u.reservebtn.addClass("loading");var e=c(this).attr("data-model"),t=c(this).attr("data-os"),r=c(this).attr("data-carrier"),s=u.reservebtn.prevUntil(u.reservebtn.parent(),"input").val(),i=""!==s?s:"",a=u.reservebtn.prevUntil(u.reservebtn.parent(),"select").val();v.set("lastUsedModal",e),v.set("lastUsedId",""!==s||void 0!==s?s:""),f.rtlApi("POST",u.params,JSON.stringify({timeSlot:a,deviceSearchRequest:{models:[e],deviceIds:[i],osVersions:[t],carriers:[r]}}),"reservation-service/api/reservations",function(e){400===e.status?(u.reservebtn.removeClass("loading"),u.reservebtn.prev().hasClass("error")?u.reservebtn.prevUntil(u.reservebtn.parent(),".error").animateCss("flash"):u.reservebtn.before('<span class="error animated">'+e.responseJSON.errors[0]+"</span>")):e.statusText&&"error"===e.statusText?(u.reservebtn.addClass("loading"),console.log("Error : error back from Server")):c(".progressbar li:eq(2)").addClass("icon-checkmark  active").delay(500).queue(function(){T(u.insideIframe,u.userInfo,e)})})}),l.resize(function(){C()}).resize(),o.on("click",".panel-buttons li",u,function(e){var i=c(this);i.toggleClass("active",!i.hasClass("active")),C(function(e){switch(i.attr("class")){case"logs":case"logs active":var t=c(".logs.panel");if(t.length){var r=c(".logs-filter option:selected").val().toLowerCase();t.remove(),a.logs("cmdStopLogs",r)}else p.callMst("logsPanel",function(e){var t=d.render(e,{});c(".panels-container").append(t),c(".logs-filter").change(function(){var e=c("select option:selected").val().toLowerCase();a.logs("cmdStartLogs",e)}).change(),c(".save-logs").click(function(){u.params.rId=u.rId,f.rtlApi("GET",u.params,null,"ffmpeg-service/api/log/"+u.rId,function(e){200===e.status?c.fileDownload(e.responseText):console.log("File not exit on server!!!!")})}),c(".clear-logs").click(function(){a.cmds("cmdClearLogs",null)}),c(".search-container .icon-search").click(function(){var e=c.trim(c("#myTags").val());0<e.length&&a.cmds("cmdFilterLogs",e)}),c("input#myTags").keypress(function(e){13==e.which&&(e.preventDefault(),c(".search-container .icon-search").trigger("click"))})});break;case"Wipe":case"Wipe active":a.Wipe();break;case"screenshot":case"screenshot active":var s=c(".screenshot.panel");s.length?s.remove():p.callMst("screenshotPanel",function(e){var t=d.render(e,{});c(".panels-container").append(t),a.takeScreenshot(),c("#btn-Preview-Image").on("click",function(){c("#previewImage").empty(),a.takeScreenshot()}),c("#btn-Clear-Screenshot").on("click",function(){c("#previewImage").empty()}),c("#btn-Convert-Html2Image").on("click",function(){a.downloadScreenshot()})});break;default:console.log("Nothing happens reached default")}})}),o.on("click",".toolbar li",function(){switch(c(this).toggleClass("active"),c(this).attr("class")){case"power":case"power active":a.toolAction("POWER","tracker");break;case"home":case"home active":a.toolAction("HOME","tracker");break;case"go_back":case"go_back active":a.toolAction("BACK","tracker");break;case"recent_apps":case"recent_apps active":a.toolAction("RECENT_APPS","tracker");break;case"vol_up":case"vol_up active":a.toolAction("VOL_UP","tracker");break;case"vol_down":case"vol_down active":a.toolAction("VOL_DOWN","tracker");break;case"bixby":case"bixby active":a.toolAction("BIXBY","tracker");break;case"swipe":case"swipe active":var e=c(".toolbar.swipe");e.length?e.remove():p.callMst("swipeToolbar",function(e){var t=d.render(e,{});c(".panels-container").prepend(t),c(".toolbar.swipe").css("top",c("li.swipe").position().top-2+"px")});break;case"swipe_top":case"swipe_top active":a.toolAction("SWIPE_TOP","tracker");break;case"swipe_left":case"swipe_left active":a.toolAction("SWIPE_LEFT","tracker");break;case"swipe_bottom":case"swipe_bottom active":a.toolAction("SWIPE_BOTTOM","tracker");break;case"swipe_right":case"swipe_right active":a.toolAction("SWIPE_RIGHT","tracker");break;default:console.log("Nothing happens reached default")}}),o.on("mouseleave",".toolbar.swipe",function(e){c(".toolbar.swipe").remove()}),o.on("mouseenter",".device-panel",function(e){c(".toolbar.swipe").remove()});var x=function(e,t){c(".loader").remove(),e.find(".available-devices").empty(),c(".noData").length||e.append('<div class="noData">'+t+"</div>")},A=function(o,e){var t=o.platforms.android?"android":"tizen",l=c(".device-results");0===l.find(".loader").length&&l.find("h3").append('<div class="loader"></div>'),o.platforms.android?(e?o.series.length&&o.osVersions.length&&o.carriers.length:o.series.length)?f.rtlApi("POST",u.params,JSON.stringify({platforms:[t],series:o.series,osVersions:o.osVersions,carriers:o.carriers}),"device-service/api/search",function(e){if(e.statusText&&"error"===e.statusText)console.log("Error : error back from Server");else{c(".loader").remove();var r=[];if(0<o.series.length){c(".noData").remove();for(var t=0;t<o.series.length;t++)for(var s=0;s<e.length;s++)0===e[s].model.indexOf(u.rtlState.series[t])&&r.push({idx:s,device:e[s].model,product:e[s].product,carrier:e[s].carrier,osVersion:e[s].osVersion,imageUrl:"https://s3.amazonaws.com/rtlassets/"+e[s].product.toLowerCase()+"/"+encodeURIComponent(e[s].model.toLowerCase())+".png",deviceId:e[s]===v.get("lastUsedModal")&&"undefined"!==v.get("lastUsedId")?v.get("lastUsedId"):"",active:"S7 Active"===e[s].modal||"S8 Active"===e[s].modal||"S9 Active"===e[s].modal?"Yes":"No"});if(e.status)l.find("h3").append('<span class="error">Error : '+e.responseJSON.message+"</span>");else{for(var i={},a=(s=0,r.length);s<a;s++){for(n in i)i[n].device===r[s].device&&i[n].osVersion!==r[s].osVersion&&(i[r[s].device+i[n].idx]=i[n]);i[r[s].device]=r[s]}for(var n in r=[],i)r.push(i[n]);r.sort(function(e,t){return t.device===e.device?parseFloat(t.osVersion)>parseFloat(e.osVersion):t.device>e.device}),0!==r.length?p.callMst("deviceList",function(e){var t=d.render(e,{list:r,role:!0===u.isDeveloper});l.find(".available-devices").html(t)}):x(l,"No matching devices found.\nTry changing some filters to see more devices.")}}}}):x(l,"No matching devices found.\nTry changing some filters to see more devices."):x(l,"This Platform is not supported yet.\nWill be coming soon.")},D=function(i,a,n,o){i<a.length&&(f.rtlApi("GET",u.params,null,"device-service/api/platforms/"+n+"/"+a[i],function(e){var r=[];for(var t in e)if(r.push({idx:t,type:a[i],val:e[t],checked:!0,disabled:!1}),"series"===a[i])for(var s in o.series)r[t].checked=o.series[s]===r[t].val;else"carriers"===a[i]?u.rtlState.carriers.push(e[t]):"os-versions"===a[i]&&u.rtlState.osVersions.push(e[t]);p.callMst("subFilter",function(e){var t=d.render(e,{list:r,series:"series"===a[i]});c(".android-"+a[i]).html(t),c("."+a[i]+"-loader").remove(),D(++i,a,n,o)})}),c(".android-"+a[i]).prev().append('<div class="'+a[i]+'-loader"></div>'))},O=function(a){var s=a.platforms.android?"android":"tizen";p.callMst("filters",function(e){var t=c(".filters-breakdown"),r=d.render(e,{android:a.platforms.android,tizen:a.platforms.tizen});t.html(r);D(0,["series","carriers","os-versions"],s,a),t.find('[type="radio"]').change(function(){switch(c(this).attr("id")){case"tizen":c(".slideRight").removeClass("slideRight"),c(".filters-breakdown > li:not(:first-child)").addClass("slideLeft"),a.platforms={android:!1,tizen:!0};break;case"android":c(".slideLeft").removeClass("slideLeft"),c(".filters-breakdown > li:not(:first-child)").addClass("slideRight"),a.platforms={android:!0,tizen:!1}}A(a,0)}),t.on("change",'[type="checkbox"]',function(){var e,t,r,s,i;e=a,t=this.checked,r=c(this).attr("name"),s=c(this).attr("id"),i=function(e){A(e,1)},s.startsWith("os")?t?e.osVersions.push(r):e.osVersions.splice(e.osVersions.indexOf(r),1):s.startsWith("series")?t?e.series.push(r):e.series.splice(e.series.indexOf(r),1):s.startsWith("carriers")&&(t?e.carriers.push(r):e.carriers.splice(e.carriers.indexOf(r),1)),i(e)})})};return{reservationStatus:w,appView:T}});